---
title: "Relatório do projeto"
author: "Marwin Carmo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Descrição da página

Este projeto buscou dados encontrados na página da Câmara Municipal do Rio de Janeiro <http://www.camara.rj.gov.br/>.

Esta página disponibiliza diversas informações a respeito da produção e atividade dos veradores da cidade. Ela é atualizada sempre que necessário com todos os materiais das atividades das Sessões Plenárias.

A escolha desta página para análise foi motivada pela falta de recursos facilmente acessíveis para que a população acompanhe um resumo da atividade parlamentar do município do Rio de Janeiro.

As informações aqui apresentadas se referem à 10ª Legislatura, que compreende o os anos de 2017 a 2020.

Primeiro será apresentada a composição atual da Câmara Municipal e a frequência dos parlamentares.

Em relação à atividade parlamentar, buscou-se informações a respeito de Projetos de Emenda à Lei Orgânica, Projetos de Lei Complementar, Projetos de Lei, Projetos de Decreto Legislativo, Projetos de Resolução, Indicações, Moções, Requerimentos de Informação, Requerimentos e Ofícios. Também foram coletadas as Leis Complementares e Emendas à Lei Orgânica que entraram em vigor no período especificado.

## Fluxo do webscrapping

Em geral, todas as páginas coletadas apresentaram uma estrutura similar. Para exemplificar, irei apresentar a raspagem feita na página de Projetos de Lei.

O site oferece as informações organizadas por **número**, por **ano**, ou por **autor**. Como o interesse do projeto é buscar os dados por ano, para facilitar a filtragem do material desejado a raspagem foi realizada pela aba **POR ANO** para a maioria das matérias legislativas, excetuando-se algumas que apresentaram uma estrutura diferente das demais, e que serão apresentadas ao final desta sessão.

As páginas puderam ser acessadas com uma simples requisição GET, sem a necessidade de se incluírem parâmetros adicionais. A página principal de exibição dos resultados não nos mostra todos, sendo necessário ir clicando em "próximo" até se obter todos os resultados do ano desejado.

## Bibliotecas utilizadas

```{r library, eval = FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(lubridate)

```


### Os headers de requisição foram

``` {r requisicao, eval = FALSE}
  u_base <- "https://mail.camara.rj.gov.br/APL/Legislativos/scpro1720.nsf/Internet/LeiEmentaInt"
  q_base <- list(
    "OpenForm" = "",
    "Start" = 1,   # Número da página atual.
    "Count" = 100, # Quantidade de resultados apresentados na página.
    "Expand" = 1   # Índice do ano (Se descendente, 1 para 2020, 2 para 2019...)
  )
  get_materia <- GET(u_base, query = q_base)
```

O valor de `Start` para a troca de página segue uma lógica pouco intuitiva. No exemplo acima, a primeira página começa em `1`, a seguinte é `1.99`, depois `1.198`, `1.297`, `1.396`, acrescentando 1 após o decimal e diminuindo 1 do último número.
Para contornar este problema, optei por modificar o valor de `Count` para `1000`, já que assim conseguiria que a página me retornasse todos os resultados e, verificando que nenhuma ano retornava mais do que 1000 resultados, esta solução foi suficiente para obter os dados desejados.

## Raspagem dos dados

As informações a respeito dos Projetos de Lei e demais matérias são apresentadas no formato de tabela. Assim, foi feita uma leitura do html da página por meio da função `xml2::read_html(get_materia)`, seguida de uma busca por todas as tabelas com `xml2::xml_find_all('//table')`:

```{r raspagem, eval = FALSE}
read_html(get_materia) %>%  # lê o html da página
    xml_find_all('//table') %>% # busca os nodes do tipo table
    magrittr::extract2(2) %>%   # extrai o segundo node, que contém a tabela principal
    html_table(fill = TRUE) %>% # leitura da tabela
    janitor::clean_names() %>%  # renomeia as colunas para um formato mais fácil de leitura e manipulação
    select(c("x_2", "ementa", "data_publ", "autor_es")) %>% # seleciona apenas as colunas com as informações desejadas. o restante é 'lixo'
    set_names(c("prolei_num", "ementa", "data_publi", "autores")) %>% # renomeia as colunas para nomes mais amigáveis
    as_tibble() %>% # transforma o dataframe em tibble
    separate_rows(autores, sep = ",") %>% # separa autores do projeto em uma linha para cada. a maioria está separada por "," mas ainda há alguns nomes separados por "E" e que devem ser corrigidos depois (não foram neste projeto)
    filter(str_detect(ementa, "^[A-Z]")) %>% # verifica na coluna ementa apenas as linhas que começam por letras. Há linhas com NAs e o ano que não correspondem à observações com informações
    mutate(data_publi = mdy(data_publi), # este mutate transforma a data de character 
           ementa = str_squish(ementa),  # para date; elimina "sujeiras" no texto da
           autores = str_to_title(autores), # ementa; torna maiúsculos apenas o nome e 
           autores = str_remove(autores, "(Vereador)(a*) ")) # sobrenome dos autores;
# e retira o título vereador/Vereadora da frente do nome. 
# Estes dois últimos passos do mutate são importantes para unificar posteriormente 
# este dataframe com o dataframe contendo as informações dos candidatos.
```


```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
